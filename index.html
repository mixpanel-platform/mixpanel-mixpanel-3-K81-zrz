<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="//cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css">
  </head>
  <body class="mixpanel-platform-body">
      <div class='row'>
        <div id="leadSelect" style="float: left"></div>
        <div id="by" class="mixpanel-platform-label" style="margin-left: 10px; display: none;">by</div>
        <div id="dateSelect" style="float: right;"></div>
      </div>
      <div class="row">
        <div class="col-lg-12">
           <div class="panel panel-default">
              <div class="panel-heading text-center">
                 Pricing Page Activity
              </div>
              <div class="panel-body">
               <div id="datatable1_wrapper" class="dataTables_wrapper form-inline no-footer">
                <div class="row">
                  <div class="col-xs-6">
                    <div class="dataTables_length" id="datatable1_length"></div></div><div class="col-xs-6"><div id="datatable1_filter" class="dataTables_filter"></div></div></div>
                      <table id="datatable1" class="table table-striped table-hover dataTable no-footer" role="grid" aria-describedby="datatable1_info">
                    	  <thead>
                        <tr role="row">
                          <th class="sorting_asc" tabindex="0" aria-controls="datatable1" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Rendering engine: activate to sort column descending" style="width: 161px;">Lead Info</th>
                          <th class="sort-numeric sorting" tabindex="0" aria-controls="datatable1" rowspan="1" colspan="1" aria-label="Engine version: activate to sort column ascending" style="width: 135px;"> Company</th>
                          <th class="sorting" tabindex="0" aria-controls="datatable1" rowspan="1" colspan="1" aria-label="Browser: activate to sort column ascending" style="width: 237px;">Pricing Page Views</th>
                            <th class="sorting" tabindex="0" aria-controls="datatable1" rowspan="1" colspan="1" aria-label="Platform(s): activate to sort column ascending" style="width: 211px;">Last Pricing Page View</th>
                            <th class="sort-alpha sorting" tabindex="0" aria-controls="datatable1" rowspan="1" colspan="1" aria-label="CSS grade: activate to sort column ascending" style="width: 97px;">Last Activity Date</th>
                            <th class="sort-numeric sorting" tabindex="0" aria-controls="datatable1" rowspan="1" colspan="1" aria-label="Engine version: activate to sort column ascending" style="width: 135px;"> Predict Grade</th>
                            
                         	</tr>
                        </thead>
                        <tbody>
                        		
                        </tbody>
                      </table>
                      <div class="row">
                          <div class="col-xs-6">
                              <div class="dataTables_info" id="datatable1_info" role="status" aria-live="polite">
                              </div>
                          </div>
                          <div class="col-xs-6">
                              <div class="dataTables_paginate paging_simple_numbers" id="datatable1_paginate">
                                  
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
           </div>
        </div>
     </div>
    
    <div id="table"></div>
    <script>
      
    
      $(document).ready(function() {
        var table = $('#datatable1').DataTable({
          "pageLength": 25
        });
        /* Query for all Mixpanel Sales reps first */
        var repData = {
          'items': []
        }
        var queryLeads = MP.api.query('/api/2.0/segmentation/', {event: 'View pricing page', on: 'user["Lead owner name"]', unit: 'month'}, {dataType: 'json'})

        queryLeads.done(function(json) {
            var mixpanelReps = _.keys(json.data.values);
       
            _.each(mixpanelReps, function(rep){
              repData.items.push({'label': rep, 'value': rep});
            })
            
            /* Bootstrap overrides our option select's height */
            dropdown = $('#leadSelect').MPSelect(repData);
            $('#leadSelect .select_button').css('height', '32px');
            
            
            dateSelect  = $('#dateSelect').MPDatepicker();
            dropdown.on('change', function(e, selection) {  
              /* Bootstrap Override again */
             $('#leadSelect .select_button').css('height', '32px');
              var rep = $('#leadSelect').val();
              var date = $('#dateSelect').val();
              runQuery(rep, date);
            });
            
            dateSelect.on('change', function(e, selection){
              var rep = $('#leadSelect').val();
              var date = $('#dateSelct').val();
              runQuery(rep, date);
            })
        })
        
      });
      

      var runQuery = function(accountRep, dates) {
        console.log(accountRep, dates);
        
        /* Query View pricing page event with account rep as property */
        var tableData = {};
        var peopleData = {};
        var pricingData = {};
        var onClause = 'properties["Email"]'
        var whereClause = '("' + accountRep + '" in string(user["Lead owner name"])) and (defined (user["Lead owner name"]))'
        
        var pricingPageQuery = MP.api.query('/api/2.0/segmentation/', {event: 'View pricing page', where: whereClause, on: onClause, from:dates.from, to: dates.to}, {dataType: 'json'})
        
        pricingPageQuery.done(function(response){
          /* Make People Queries */
          
          var queries = [];
          
          var responseData = response.data.values;
          
         
          var leadEmails = _.keys(responseData);
          
          _.each(leadEmails, function(userEmail){
            if (userEmail != undefined || userEmail != 'undefined'){
              var peopleQuery = MP.api.people({where: 'properties["$email"] == "' + userEmail + '"'})
            }
            queries.push(peopleQuery);
          })
          Promise.all(queries).then(function(peopleQueries){
           
            _.each(peopleQueries, function(leadData){
              var userDatum = leadData.values();
              if (_.contains(_.keys(userDatum.results), '0')) {
                var email = userDatum.results[0].$properties['$email'];
                peopleData[email] = userDatum.results[0].$properties;
              }
            })
            
            console.log(peopleData)
            _.each(leadEmails, function(email){
                var pricingViews = responseData[email];
                var views = _.values(pricingViews)
                var viewSummed = _.reduce(views, function(memo, num){ return memo + num; }, 0);
                var tempDates = []
                var lastViewDate;
                var lastActivityDate;
                var predictGrade;
                var company;
                
                _.each(_.keys(pricingViews), function(date){
                  if (pricingViews[date] != 0) {
                    tempDates.push(date);
                  }
                })
                tempDates.sort().reverse();
                lastViewDate = _.first(tempDates) ? _.first(tempDates) : 'N/A';
                
                if (email in peopleData){
                  console.log(peopleData[email])
                  console.log('here')
                  lastActivityDate = '$last_seen' in peopleData[email] ? peopleData[email]['$last_seen'].split('T')[0] : 'N/A' 
                  predictGrade = '$predict_grade' in peopleData[email] ? peopleData[email]['$predict_grade'] : 'N/A'
                  console.log(predictGrade)
                  debugger;
                  company = 'Company' in peopleData[email] ? peopleData[email]['Company'] : 'N/A'
                  tableData[email] = [email, company, viewSummed, lastViewDate, lastActivityDate, predictGrade];
                  console.log(tableData)
                  
                }
                
            })
            drawTable(tableData);
          }) 
          
        });
        
      }
      
      var drawTable = function(data){
        var table = $('#datatable1').DataTable();
        /* Clear it before we Draw Again */
        table.clear();
        
        _.each(_.keys(data), function(datum){
            table.row.add(data[datum]).draw(false);
        });
        
        table.order([2, 'desc']).draw();
        

      }
    
    </script>
  </body>
</html>
